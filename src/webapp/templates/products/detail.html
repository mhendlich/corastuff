{% extends "base.html" %}

{% block title %}{{ product.name }} - Corastuff{% endblock %}

{% block breadcrumbs %}
<nav class="text-xs text-slate-500 mb-1" aria-label="Breadcrumb">
    <ol class="flex items-center space-x-2">
        <li><a href="/products" class="hover:text-slate-200">Products</a></li>
        <li class="text-slate-600">/</li>
        <li class="text-slate-300 truncate">{{ product.name }}</li>
    </ol>
</nav>
{% endblock %}

{% block page_title %}{{ product.name }}{% endblock %}
{% block page_subtitle %}
{% if product.description %}
<p class="mt-1 text-sm text-slate-400">{{ product.description }}</p>
{% endif %}
{% endblock %}
{% block page_actions %}
<a href="/products/{{ product.id }}/edit" class="app-btn-secondary inline-flex items-center px-3 py-2 rounded-md text-sm font-medium">
    Edit
</a>
<form action="/products/{{ product.id }}/delete" method="POST" onsubmit="return confirm('Delete this product and all its links?')" class="inline">
    <button type="submit" class="inline-flex items-center px-3 py-2 rounded-md text-sm font-medium bg-red-500/15 text-red-200 border border-red-500/40 hover:bg-red-500/25">
        Delete
    </button>
</form>
{% endblock %}

{% block content %}

<div class="mt-6">
    <h2 class="text-sm font-semibold tracking-wide text-white/90 mb-3">
        Linked Source Products ({{ links|length }})
    </h2>

    {% set links_with_prices = links | selectattr('price') | list %}
    {% set best_price = links_with_prices | map(attribute='price') | min if links_with_prices else none %}

    {% if links %}
    <div class="app-card overflow-hidden">
        <table class="min-w-full divide-y divide-white/10 text-sm">
            <thead class="bg-white/5">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase tracking-wider">Source</th>
                    <th scope="col" class="px-6 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase tracking-wider">Product Name</th>
                    <th scope="col" class="px-6 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase tracking-wider">Price</th>
                    <th scope="col" class="px-6 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase tracking-wider">Item ID</th>
                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                </tr>
            </thead>
            <tbody class="divide-y divide-white/5">
                {% for link in links %}
                {% set is_best = link.price and link.price == best_price %}
                <tr class="{% if is_best %}bg-emerald-500/10{% endif %} hover:bg-white/5">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-semibold bg-brand/15 text-brand-soft border border-brand/30">
                            {{ link.source }}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-white">{{ link.name or 'N/A' }}</div>
                        {% if link.url %}
                        <a href="{{ link.url }}" target="_blank" class="text-xs text-brand-cyan hover:text-white">View on site</a>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if link.price %}
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium {% if is_best %}text-emerald-300{% else %}text-slate-100{% endif %}">{{ "%.2f"|format(link.price) }} {{ link.currency or '' }}</span>
                            {% if is_best %}
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-bold bg-emerald-500 text-white">BEST</span>
                            {% endif %}
                        </div>
                        {% else %}
                        <span class="text-sm text-slate-500">N/A</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">
                        {{ link.source_item_id }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <form action="/link/unlink" method="POST" class="inline">
                            <input type="hidden" name="source" value="{{ link.source }}">
                            <input type="hidden" name="source_item_id" value="{{ link.source_item_id }}">
                            <input type="hidden" name="redirect" value="/products/{{ product.id }}">
                            <button type="submit" class="text-red-300 hover:text-red-200">Unlink</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if links_with_prices %}
    <div class="mt-4 app-card p-4">
        <h3 class="text-sm font-semibold text-white mb-2">Price Comparison</h3>
        <div class="flex flex-wrap gap-4">
            {% for link in links if link.price %}
            {% set is_best = link.price == best_price %}
            <div class="flex items-center space-x-2 {% if is_best %}bg-emerald-500/15 px-2 py-1 rounded{% endif %}">
                <span class="text-xs font-medium text-slate-400">{{ link.source }}:</span>
                <span class="text-sm font-semibold {% if is_best %}text-emerald-300{% else %}text-white{% endif %}">{{ "%.2f"|format(link.price) }} {{ link.currency or '' }}</span>
                {% if is_best %}<span class="text-xs text-emerald-300 font-medium">(Best)</span>{% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="app-card p-8 text-center">
        <svg class="mx-auto h-12 w-12 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
        </svg>
        <h3 class="mt-2 text-sm font-semibold text-white">No linked products</h3>
        <p class="mt-1 text-sm text-slate-400">Link source products to this canonical product.</p>
        <div class="mt-4">
            <a href="/link" class="app-btn inline-flex items-center px-4 py-2 rounded-md text-sm font-semibold">
                Link Products
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
