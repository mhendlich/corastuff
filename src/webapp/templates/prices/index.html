{% extends "base.html" %}

{% block title %}Prices - Corastuff{% endblock %}

{% block page_title %}Prices{% endblock %}
{% block page_subtitle %}
<p class="mt-1 text-sm text-slate-400">Explore live prices and trends across sources</p>
{% endblock %}
{% block page_actions %}
<div class="flex space-x-2">
    <button id="btn-table" onclick="showView('table')"
            class="px-3 py-1.5 text-sm font-semibold rounded-md bg-brand text-white shadow shadow-brand/40">
        Table
    </button>
    <button id="btn-cards" onclick="showView('cards')"
            class="px-3 py-1.5 text-sm font-semibold rounded-md bg-white/5 text-slate-200 hover:bg-white/10 border border-white/10">
        Cards
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Search and Filter -->
<div class="app-card p-4 mb-6">
    <div class="flex gap-4 items-center">
        <div class="flex-1">
            <label for="search-input" class="sr-only">Search products</label>
            <div class="relative">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                <input type="text" id="search-input" placeholder="Search by product name..."
                       class="app-input block w-full pl-10 pr-3 py-2 rounded-md leading-5 text-sm focus:outline-none focus:ring-2 focus:ring-brand/60"
                       oninput="filterProducts()">
            </div>
        </div>
        <div class="flex gap-2">
            <select id="source-filter" class="app-input pl-3 pr-10 py-2 text-sm rounded-md focus:outline-none focus:ring-2 focus:ring-brand/60" onchange="filterProducts()">
                <option value="">All Sources</option>
                {% for source in sources %}
                <option value="{{ source }}">{{ source }}</option>
                {% endfor %}
            </select>
            <select id="price-filter" class="app-input pl-3 pr-10 py-2 text-sm rounded-md focus:outline-none focus:ring-2 focus:ring-brand/60" onchange="filterProducts()">
                <option value="">Any Price</option>
                <option value="0-25">Under 25</option>
                <option value="25-50">25 - 50</option>
                <option value="50-100">50 - 100</option>
                <option value="100+">Over 100</option>
            </select>
        </div>
    </div>
    <div id="filter-results" class="mt-2 text-sm text-slate-400 hidden">
        Showing <span id="visible-count">0</span> products
    </div>
</div>

    {% if canonical_products %}
    <div class="mb-8">
        <h2 class="text-sm font-semibold tracking-wide text-white/90 mb-3">Canonical Products</h2>
        <div class="app-card overflow-hidden">
            <table class="min-w-full divide-y divide-white/10 text-sm">
                <thead class="bg-white/5">
                    <tr>
                        <th class="px-6 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase">Product</th>
                        <th class="px-6 py-3 text-left text-[11px] font-semibold text-slate-400 uppercase">Linked Sources</th>
                        <th class="px-6 py-3 text-right text-[11px] font-semibold text-slate-400 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for product in canonical_products %}
                    <tr class="hover:bg-white/5">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-white">{{ product.name }}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-400">
                            -
                        </td>
                        <td class="px-6 py-4 text-right">
                            <a href="/prices/canonical/{{ product.id }}" class="text-brand-cyan hover:text-white text-sm font-medium">
                                View Prices
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Table View -->
    <div id="view-table">
        <h2 class="text-sm font-semibold tracking-wide text-white/90 mb-3">All Products by Source</h2>
        {% for source, products in products_by_source.items() %}
        <div class="mb-6">
            <h3 class="text-sm font-semibold text-slate-200 mb-2 flex items-center">
                <span class="inline-block w-3 h-3 rounded-full mr-2
                    {% if source == 'bergzeit' %}bg-green-500
                    {% elif source == 'sportscheck' %}bg-blue-500
                    {% elif source == 'galaxus_ch' %}bg-purple-500
                    {% elif source == 'galaxus_de' %}bg-pink-500
                    {% elif source == 'kaufland' %}bg-orange-500
                    {% else %}bg-gray-500{% endif %}"></span>
                {{ source }} ({{ products|length }} products)
            </h3>
            <div class="app-card overflow-hidden">
                <table class="min-w-full divide-y divide-white/10 text-sm">
                    <thead class="bg-white/5">
                        <tr>
                            <th class="px-4 py-2 text-left text-[11px] font-semibold text-slate-400 uppercase">Name</th>
                            <th class="px-4 py-2 text-right text-[11px] font-semibold text-slate-400 uppercase">Price</th>
                            <th class="px-4 py-2 text-right text-[11px] font-semibold text-slate-400 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        {% for product in products %}
                        <tr class="hover:bg-white/5 product-row" data-source="{{ source }}" data-name="{{ product.name | lower }}" data-price="{{ product.price or 0 }}">
                            <td class="px-4 py-2">
                                <div class="text-sm text-white truncate max-w-md" title="{{ product.name }}">
                                    {{ product.name }}
                                </div>
                            </td>
                            <td class="px-4 py-2 text-right">
                                <div class="flex items-center justify-end gap-2">
                                    <span class="text-sm font-medium text-white">
                                        {% if product.price %}
                                        {{ "%.2f"|format(product.price) }} {{ product.currency or 'EUR' }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </span>
                                    {% if product.price_change is not none %}
                                        {% if product.price_change < 0 %}
                                        <span class="inline-flex items-center text-xs text-green-600" title="Price dropped {{ "%.2f"|format(product.price_change|abs) }} ({{ "%.1f"|format(product.price_change_pct|abs) }}%)">
                                            <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                            {{ "%.1f"|format(product.price_change_pct|abs) }}%
                                        </span>
                                        {% elif product.price_change > 0 %}
                                        <span class="inline-flex items-center text-xs text-red-600" title="Price increased {{ "%.2f"|format(product.price_change) }} (+{{ "%.1f"|format(product.price_change_pct) }}%)">
                                            <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                                            +{{ "%.1f"|format(product.price_change_pct) }}%
                                        </span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-4 py-2 text-right">
                                {% if product.item_id %}
                                <a href="/prices/product/{{ source }}/{{ product.item_id }}" class="text-brand-cyan hover:text-white text-xs">
                                    History
                                </a>
                                {% endif %}
                                {% if product.url %}
                                <a href="{{ product.url }}" target="_blank" class="text-slate-400 hover:text-slate-200 text-xs ml-2">
                                    Visit
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Cards View -->
    <div id="view-cards" class="hidden">
        <h2 class="text-sm font-semibold tracking-wide text-white/90 mb-3">All Products</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for source, products in products_by_source.items() %}
            {% for product in products %}
            <div class="app-card app-card-hover p-4 product-card" data-source="{{ source }}" data-name="{{ product.name | lower }}" data-price="{{ product.price or 0 }}">
                <div class="flex justify-between items-start mb-2">
                    <span class="inline-block px-2 py-0.5 text-[11px] rounded border
                        {% if source == 'bergzeit' %}bg-green-500/15 text-green-300 border-green-500/30
                        {% elif source == 'sportscheck' %}bg-blue-500/15 text-blue-300 border-blue-500/30
                        {% elif source == 'galaxus_ch' %}bg-purple-500/15 text-purple-300 border-purple-500/30
                        {% elif source == 'galaxus_de' %}bg-pink-500/15 text-pink-300 border-pink-500/30
                        {% elif source == 'kaufland' %}bg-orange-500/15 text-orange-300 border-orange-500/30
                        {% else %}bg-white/5 text-slate-200 border-white/10{% endif %}">
                        {{ source }}
                    </span>
                    {% if product.price %}
                    <div class="text-right">
                        <span class="text-lg font-bold text-white">
                            {{ "%.2f"|format(product.price) }} {{ product.currency or 'EUR' }}
                        </span>
                        {% if product.price_change is not none %}
                            {% if product.price_change < 0 %}
                            <div class="text-xs text-green-600 flex items-center justify-end">
                                <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                                {{ "%.1f"|format(product.price_change_pct|abs) }}%
                            </div>
                            {% elif product.price_change > 0 %}
                            <div class="text-xs text-red-600 flex items-center justify-end">
                                <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 9.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 7.414V15a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                                +{{ "%.1f"|format(product.price_change_pct) }}%
                            </div>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <h3 class="text-sm font-medium text-white mb-2 line-clamp-2">{{ product.name }}</h3>
                <div class="flex justify-between items-center text-xs">
                    {% if product.item_id %}
                    <a href="/prices/product/{{ source }}/{{ product.item_id }}" class="text-brand-cyan hover:text-white">
                        View History
                    </a>
                    {% else %}
                    <span></span>
                    {% endif %}
                    {% if product.url %}
                    <a href="{{ product.url }}" target="_blank" class="text-slate-400 hover:text-slate-200">
                        Visit Store
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

<script>
function showView(view) {
    document.getElementById('view-table').classList.toggle('hidden', view !== 'table');
    document.getElementById('view-cards').classList.toggle('hidden', view !== 'cards');
    document.getElementById('btn-table').classList.toggle('bg-brand', view === 'table');
    document.getElementById('btn-table').classList.toggle('text-white', view === 'table');
    document.getElementById('btn-table').classList.toggle('bg-white/5', view !== 'table');
    document.getElementById('btn-table').classList.toggle('text-slate-200', view !== 'table');
    document.getElementById('btn-cards').classList.toggle('bg-brand', view === 'cards');
    document.getElementById('btn-cards').classList.toggle('text-white', view === 'cards');
    document.getElementById('btn-cards').classList.toggle('bg-white/5', view !== 'cards');
    document.getElementById('btn-cards').classList.toggle('text-slate-200', view !== 'cards');
    filterProducts(); // Re-apply filters when switching views
}

function filterProducts() {
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const sourceFilter = document.getElementById('source-filter').value;
    const priceFilter = document.getElementById('price-filter').value;

    let visibleCount = 0;

    // Filter table rows
    document.querySelectorAll('.product-row').forEach(row => {
        const name = row.dataset.name;
        const source = row.dataset.source;
        const price = parseFloat(row.dataset.price) || 0;

        const matchesSearch = !searchTerm || name.includes(searchTerm);
        const matchesSource = !sourceFilter || source === sourceFilter;
        const matchesPrice = checkPriceFilter(price, priceFilter);

        const visible = matchesSearch && matchesSource && matchesPrice;
        row.classList.toggle('hidden', !visible);
        if (visible) visibleCount++;
    });

    // Filter cards
    document.querySelectorAll('.product-card').forEach(card => {
        const name = card.dataset.name;
        const source = card.dataset.source;
        const price = parseFloat(card.dataset.price) || 0;

        const matchesSearch = !searchTerm || name.includes(searchTerm);
        const matchesSource = !sourceFilter || source === sourceFilter;
        const matchesPrice = checkPriceFilter(price, priceFilter);

        const visible = matchesSearch && matchesSource && matchesPrice;
        card.classList.toggle('hidden', !visible);
    });

    // Hide source sections with no visible products in table view
    document.querySelectorAll('#view-table > div').forEach(section => {
        const visibleRows = section.querySelectorAll('.product-row:not(.hidden)');
        section.classList.toggle('hidden', visibleRows.length === 0);
    });

    // Update filter results display
    const filterResults = document.getElementById('filter-results');
    const visibleCountEl = document.getElementById('visible-count');

    if (searchTerm || sourceFilter || priceFilter) {
        filterResults.classList.remove('hidden');
        visibleCountEl.textContent = visibleCount;
    } else {
        filterResults.classList.add('hidden');
    }
}

function checkPriceFilter(price, filter) {
    if (!filter) return true;
    switch(filter) {
        case '0-25': return price > 0 && price < 25;
        case '25-50': return price >= 25 && price < 50;
        case '50-100': return price >= 50 && price < 100;
        case '100+': return price >= 100;
        default: return true;
    }
}
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}
