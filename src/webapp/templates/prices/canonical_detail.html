{% extends "base.html" %}

{% block title %}{{ canonical.name }} - Price Comparison{% endblock %}

{% block content %}
<div class="px-4 sm:px-0">
    <div class="mb-6">
        <a href="/prices" class="text-indigo-600 hover:text-indigo-900 text-sm">&larr; Back to Prices</a>
    </div>

    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h1 class="text-2xl font-bold text-gray-900">{{ canonical.name }}</h1>
        {% if canonical.description %}
        <p class="text-gray-600 mt-2">{{ canonical.description }}</p>
        {% endif %}
        <p class="text-sm text-gray-500 mt-2">{{ price_data|length }} linked sources</p>
    </div>

    {% if price_data %}
    <!-- Current Prices Comparison -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Current Prices</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for pd in price_data %}
            <div class="border rounded-lg p-4
                {% if pd.source == 'bergzeit' %}border-green-200 bg-green-50
                {% elif pd.source == 'sportscheck' %}border-blue-200 bg-blue-50
                {% elif pd.source == 'galaxus_ch' %}border-purple-200 bg-purple-50
                {% elif pd.source == 'galaxus_de' %}border-pink-200 bg-pink-50
                {% elif pd.source == 'kaufland' %}border-orange-200 bg-orange-50
                {% else %}border-gray-200 bg-gray-50{% endif %}">
                <div class="flex justify-between items-start">
                    <span class="text-sm font-medium text-gray-700">{{ pd.source }}</span>
                    {% if pd.url %}
                    <a href="{{ pd.url }}" target="_blank" class="text-gray-400 hover:text-gray-600 text-xs">Visit</a>
                    {% endif %}
                </div>
                <div class="text-2xl font-bold text-gray-900 mt-2">
                    {% if pd.current_price %}
                    {{ "%.2f"|format(pd.current_price) }} {{ pd.currency or 'EUR' }}
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="text-xs text-gray-500 mt-1 truncate" title="{{ pd.name }}">{{ pd.name }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Price History Chart -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Price History Comparison</h2>
        <div class="h-80">
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <!-- Price History Table -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Detailed History by Source</h2>
        </div>
        {% for pd in price_data %}
        <div class="border-b border-gray-200 last:border-b-0">
            <div class="px-6 py-3 bg-gray-50 flex justify-between items-center">
                <span class="font-medium text-gray-700">{{ pd.source }}</span>
                <a href="/prices/product/{{ pd.source }}/{{ pd.item_id }}" class="text-indigo-600 hover:text-indigo-900 text-sm">
                    View Full History
                </a>
            </div>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-6 py-2 text-right text-xs font-medium text-gray-500 uppercase">Price</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for h in pd.history[:5] %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-2 text-sm text-gray-600">{{ h.scraped_at[:16].replace('T', ' ') }}</td>
                        <td class="px-6 py-2 text-right text-sm font-medium text-gray-900">
                            {{ "%.2f"|format(h.price) }} {{ h.currency or 'EUR' }}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if pd.history|length > 5 %}
                    <tr>
                        <td colspan="2" class="px-6 py-2 text-center text-sm text-gray-500">
                            ... {{ pd.history|length - 5 }} more records
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white shadow rounded-lg p-6 text-center text-gray-500">
        No products linked to this canonical product yet.
        <a href="/link" class="text-indigo-600 hover:text-indigo-900 ml-1">Link products</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const priceData = {{ price_data | tojson }};

    if (priceData.length === 0) return;

    const ctx = document.getElementById('priceChart').getContext('2d');

    // Color palette for different sources
    const colors = {
        'bergzeit': { border: 'rgb(34, 197, 94)', bg: 'rgba(34, 197, 94, 0.1)' },
        'sportscheck': { border: 'rgb(59, 130, 246)', bg: 'rgba(59, 130, 246, 0.1)' },
        'galaxus_ch': { border: 'rgb(168, 85, 247)', bg: 'rgba(168, 85, 247, 0.1)' },
        'galaxus_de': { border: 'rgb(236, 72, 153)', bg: 'rgba(236, 72, 153, 0.1)' },
        'kaufland': { border: 'rgb(249, 115, 22)', bg: 'rgba(249, 115, 22, 0.1)' },
    };
    const defaultColor = { border: 'rgb(107, 114, 128)', bg: 'rgba(107, 114, 128, 0.1)' };

    // Collect all timestamps and calculate time range
    const allTimestamps = [];
    priceData.forEach(pd => {
        pd.history.forEach(h => allTimestamps.push(new Date(h.scraped_at).getTime()));
    });

    const minTime = Math.min(...allTimestamps);
    const maxTime = Math.max(...allTimestamps);
    const timeRange = maxTime - minTime;

    // Auto-select time unit based on range
    let timeUnit = 'day';
    if (timeRange < 1000 * 60 * 5) timeUnit = 'second';           // < 5 min
    else if (timeRange < 1000 * 60 * 60 * 2) timeUnit = 'minute'; // < 2 hours
    else if (timeRange < 1000 * 60 * 60 * 48) timeUnit = 'hour';  // < 2 days
    else if (timeRange < 1000 * 60 * 60 * 24 * 60) timeUnit = 'day'; // < 60 days
    else timeUnit = 'month';

    // Build datasets with {x, y} format using actual timestamps
    const datasets = priceData.map(pd => {
        const color = colors[pd.source] || defaultColor;

        // Convert history to {x, y} points sorted by time
        const dataPoints = pd.history
            .map(h => ({ x: new Date(h.scraped_at), y: h.price }))
            .sort((a, b) => a.x - b.x);

        return {
            label: pd.source,
            data: dataPoints,
            borderColor: color.border,
            backgroundColor: color.bg,
            fill: false,
            tension: 0.1,
            pointRadius: dataPoints.length < 50 ? 4 : 2
        };
    });

    new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        title: function(items) {
                            return new Date(items[0].parsed.x).toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: timeUnit,
                        displayFormats: {
                            second: 'HH:mm:ss',
                            minute: 'HH:mm',
                            hour: 'MMM d, HH:mm',
                            day: 'MMM d',
                            month: 'MMM yyyy'
                        }
                    },
                    ticks: {
                        maxTicksLimit: 8
                    }
                },
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(2) + ' EUR';
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
