{% extends "base.html" %}

{% block title %}{{ canonical.name }} - Price Comparison{% endblock %}

{% block breadcrumbs %}
<a href="/prices" class="text-xs text-slate-500 hover:text-slate-200">&larr; Prices</a>
{% endblock %}
{% block page_title %}{{ canonical.name }}{% endblock %}
{% block page_subtitle %}
{% if canonical.description %}
<p class="mt-1 text-sm text-slate-400">{{ canonical.description }}</p>
{% else %}
<p class="mt-1 text-sm text-slate-400">{{ price_data|length }} linked sources</p>
{% endif %}
{% endblock %}

{% block content %}
<div class="space-y-6">
    {% if price_data %}
    {% set prices_with_values = price_data | selectattr('current_price') | list %}
    {% set best_price = prices_with_values | map(attribute='current_price') | min if prices_with_values else none %}

    <!-- Current Prices Comparison -->
    <div class="app-card p-6">
        <h2 class="text-sm font-semibold tracking-wide text-white/90 mb-4">Current Prices</h2>
        <div class="grid grid-cols-3 gap-4">
            {% for pd in price_data %}
            {% set is_best = pd.current_price and pd.current_price == best_price %}
            <div class="app-card app-card-hover p-4 relative border
                {% if is_best %}border-emerald-500/60 bg-emerald-500/10 ring-2 ring-emerald-500/40
                {% elif pd.source == 'bergzeit' %}border-green-500/40 bg-green-500/10
                {% elif pd.source == 'sportscheck' %}border-blue-500/40 bg-blue-500/10
                {% elif pd.source == 'galaxus_ch' %}border-purple-500/40 bg-purple-500/10
                {% elif pd.source == 'galaxus_de' %}border-pink-500/40 bg-pink-500/10
                {% elif pd.source == 'kaufland' %}border-orange-500/40 bg-orange-500/10
                {% else %}border-white/10 bg-white/5{% endif %}">
                {% if is_best %}
                <div class="absolute -top-2 -right-2 bg-emerald-500 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow">
                    BEST PRICE
                </div>
                {% endif %}
                <div class="flex justify-between items-start">
                    <span class="text-sm font-medium text-slate-200">{{ pd.display_name or pd.source }}</span>
                    {% if pd.url %}
                    <a href="{{ pd.url }}" target="_blank" class="text-slate-400 hover:text-slate-200 text-xs">Visit</a>
                    {% endif %}
                </div>
                {% set img_src = pd.image_data|image_data_uri(pd.image_mime) %}
                {% if not img_src and pd.history %}
                    {% set img_src = pd.history[0].image_data|image_data_uri(pd.history[0].image_mime) %}
                {% endif %}
                <div class="h-28 w-full rounded-md overflow-hidden bg-white/5 border border-white/10 my-3 flex items-center justify-center">
                    {% if img_src %}
                    <img src="{{ img_src }}" alt="{{ pd.name }}" class="h-full w-full object-cover">
                    {% else %}
                    <span class="text-[11px] text-slate-400">No image</span>
                    {% endif %}
                </div>
                <div class="text-2xl font-bold mt-2 {% if is_best %}text-emerald-300{% else %}text-white{% endif %}">
                    {% if pd.current_price %}
                    {{ "%.2f"|format(pd.current_price) }} {{ pd.currency or 'EUR' }}
                    {% else %}
                    -
                    {% endif %}
                </div>
                <div class="text-xs text-slate-400 mt-1 truncate" title="{{ pd.name }}">{{ pd.name }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Price History Chart -->
    <div class="app-card p-6">
        <h2 class="text-sm font-semibold tracking-wide text-white/90 mb-4">Price History Comparison</h2>
        <div class="h-80">
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <!-- Price History Table -->
    <div class="app-card overflow-hidden">
        <div class="px-6 py-4 border-b border-white/10">
            <h2 class="text-sm font-semibold tracking-wide text-white/90">Detailed History by Source</h2>
        </div>
        {% for pd in price_data %}
        <div class="border-b border-white/10 last:border-b-0">
            <div class="px-6 py-3 bg-white/5 flex justify-between items-center">
                <span class="font-medium text-slate-200">{{ pd.display_name or pd.source }}</span>
                <a href="/prices/product/{{ pd.source }}/{{ pd.item_id }}" class="text-brand-cyan hover:text-white text-sm">
                    View Full History
                </a>
            </div>
            <table class="min-w-full divide-y divide-white/10 text-sm">
                <thead class="bg-white/5">
                    <tr>
                        <th class="px-6 py-2 text-left text-[11px] font-semibold text-slate-400 uppercase">Date</th>
                        <th class="px-6 py-2 text-right text-[11px] font-semibold text-slate-400 uppercase">Price</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for h in pd.history[:5] %}
                    <tr class="hover:bg-white/5">
                        <td class="px-6 py-2 text-sm text-slate-300">{{ h.scraped_at[:16].replace('T', ' ') }}</td>
                        <td class="px-6 py-2 text-right text-sm font-medium text-white">
                            {{ "%.2f"|format(h.price) }} {{ h.currency or 'EUR' }}
                        </td>
                    </tr>
                    {% endfor %}
                    {% if pd.history|length > 5 %}
                    <tr>
                        <td colspan="2" class="px-6 py-2 text-center text-sm text-slate-400">
                            ... {{ pd.history|length - 5 }} more records
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="app-card p-6 text-center text-slate-400">
        No products linked to this canonical product yet.
        <a href="/link" class="text-brand-cyan hover:text-white ml-1">Link products</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const priceData = {{ price_chart_data | tojson }};

    if (priceData.length === 0) return;

    const ctx = document.getElementById('priceChart').getContext('2d');

    // Color palette for different sources
    const colors = {
        'bergzeit': { border: 'rgb(34, 197, 94)', bg: 'rgba(34, 197, 94, 0.1)' },
        'sportscheck': { border: 'rgb(59, 130, 246)', bg: 'rgba(59, 130, 246, 0.1)' },
        'galaxus_ch': { border: 'rgb(168, 85, 247)', bg: 'rgba(168, 85, 247, 0.1)' },
        'galaxus_de': { border: 'rgb(236, 72, 153)', bg: 'rgba(236, 72, 153, 0.1)' },
        'kaufland': { border: 'rgb(249, 115, 22)', bg: 'rgba(249, 115, 22, 0.1)' },
    };
    const defaultColor = { border: 'rgb(107, 114, 128)', bg: 'rgba(107, 114, 128, 0.1)' };

    // Collect all timestamps and calculate time range
    const allTimestamps = [];
    priceData.forEach(pd => {
        pd.history.forEach(h => allTimestamps.push(new Date(h.scraped_at).getTime()));
    });

    const minTime = Math.min(...allTimestamps);
    const maxTime = Math.max(...allTimestamps);
    const timeRange = maxTime - minTime;

    // Auto-select time unit based on range
    let timeUnit = 'day';
    if (timeRange < 1000 * 60 * 5) timeUnit = 'second';           // < 5 min
    else if (timeRange < 1000 * 60 * 60 * 2) timeUnit = 'minute'; // < 2 hours
    else if (timeRange < 1000 * 60 * 60 * 48) timeUnit = 'hour';  // < 2 days
    else if (timeRange < 1000 * 60 * 60 * 24 * 60) timeUnit = 'day'; // < 60 days
    else timeUnit = 'month';

    // Build datasets with {x, y} format using actual timestamps
    const datasets = priceData.map(pd => {
        const color = colors[pd.source] || defaultColor;

        // Convert history to {x, y} points sorted by time
        const dataPoints = pd.history
            .map(h => ({ x: new Date(h.scraped_at), y: h.price }))
            .sort((a, b) => a.x - b.x);

        return {
            label: pd.display_name || pd.source,
            data: dataPoints,
            borderColor: color.border,
            backgroundColor: color.bg,
            fill: false,
            tension: 0.1,
            pointRadius: dataPoints.length < 50 ? 4 : 2
        };
    });

    new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        title: function(items) {
                            return new Date(items[0].parsed.x).toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: timeUnit,
                        displayFormats: {
                            second: 'HH:mm:ss',
                            minute: 'HH:mm',
                            hour: 'MMM d, HH:mm',
                            day: 'MMM d',
                            month: 'MMM yyyy'
                        }
                    },
                    ticks: {
                        maxTicksLimit: 8,
                        color: '#94a3b8'
                    },
                    grid: {
                        color: 'rgba(148, 163, 184, 0.12)'
                    }
                },
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return value.toFixed(2) + ' EUR';
                        },
                        color: '#94a3b8'
                    },
                    grid: {
                        color: 'rgba(148, 163, 184, 0.12)'
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
