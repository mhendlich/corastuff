{% extends "base.html" %}

{% block title %}Dashboard - Corastuff{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block page_subtitle %}
<p class="mt-1 text-sm text-slate-400">Overview of your product linking status</p>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div id="stats-container">
        {% include "partials/_stats.html" %}
    </div>

    <section class="app-card overflow-hidden">
        <div class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
            <div>
                <h2 class="text-sm font-semibold tracking-wide text-white/90">Data Sources</h2>
                <p class="text-xs text-slate-400 mt-0.5">Live scraper inventory and last run</p>
            </div>
            <div class="text-xs text-slate-400">{{ sources|length }} sources</div>
        </div>
        <ul role="list" class="divide-y divide-white/5">
            {% for source in sources %}
            <li class="px-6 py-4 flex items-center justify-between app-card-hover">
                <div>
                    <div class="text-sm font-medium text-white">{{ source }}</div>
                    {% if last_scrape_times and last_scrape_times.get(source) %}
                    <div class="text-xs text-slate-400 mt-1">
                        Last scraped: {{ last_scrape_times[source][:16].replace('T', ' ') }}
                    </div>
                    {% endif %}
                </div>
                <div class="flex items-center gap-3">
                    {% if last_scrape_times and last_scrape_times.get(source) %}
                    <span class="text-xs text-slate-500" id="ago-{{ source }}"></span>
                    {% endif %}
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold bg-emerald-500/15 text-emerald-300 border border-emerald-500/30">
                        Active
                    </span>
                </div>
            </li>
            {% else %}
            <li class="px-6 py-10 text-center text-sm text-slate-400">
                No sources found. Run the scrapers first.
            </li>
            {% endfor %}
        </ul>
    </section>

    <section class="app-card border border-red-500/30 overflow-hidden" id="reset-section">
        <div class="px-6 py-4 border-b border-red-500/20 bg-red-500/5 flex items-center justify-between">
            <div>
                <h2 class="text-sm font-semibold tracking-wide text-red-200">Danger Zone</h2>
                <p class="text-xs text-red-200/70 mt-0.5">Irreversible operations</p>
            </div>
        </div>
        <div class="p-6 flex items-start justify-between gap-6">
            <div>
                <h3 class="text-sm font-medium text-white">Reset All Data</h3>
                <p class="mt-1 text-sm text-slate-300/80 max-w-2xl">
                    Permanently delete all products, canonical products, links, and scraper schedules.
                    This action cannot be undone.
                </p>
            </div>
            <button
                type="button"
                onclick="confirmReset()"
                class="inline-flex items-center px-4 py-2 rounded-md text-sm font-semibold bg-red-500/90 hover:bg-red-500 text-white shadow shadow-red-500/40">
                Reset Everything
            </button>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
function confirmReset() {
    if (confirm('Are you sure you want to delete ALL data? This cannot be undone!')) {
        if (confirm('This will permanently delete all products, canonical products, links, and schedules. Are you absolutely sure?')) {
            htmx.ajax('POST', '/admin/reset-all', {
                target: '#reset-section',
                swap: 'innerHTML'
            });
        }
    }
}

// Show relative time for last scraped timestamps
function timeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);

    if (seconds < 60) return 'just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
    return Math.floor(seconds / 604800) + 'w ago';
}

// Update relative times
const lastScrapeTimes = {{ last_scrape_times | tojson if last_scrape_times else '{}' }};
for (const [source, timestamp] of Object.entries(lastScrapeTimes)) {
    const el = document.getElementById('ago-' + source);
    if (el && timestamp) {
        el.textContent = timeAgo(new Date(timestamp));
    }
}
</script>
{% endblock %}
