{% extends "base.html" %}

{% block title %}Insights - Blackroll Scraper{% endblock %}

{% block page_title %}Insights{% endblock %}

{% block page_subtitle %}
<p class="mt-1 text-sm text-slate-400">Automated signals that surface price swings, cross‑source gaps, and scrape health.</p>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-6">
        <div class="app-card p-4 bg-gradient-to-br from-brand/25 via-brand/10 to-brand-cyan/10 border-brand/20">
            <div class="text-[11px] uppercase tracking-[0.18em] text-slate-300">Recent Drops</div>
            <div class="mt-2 flex items-baseline gap-2">
                <span class="text-3xl font-semibold text-white">{{ insights.summary.price_drops }}</span>
                <span class="text-xs text-emerald-300/80">flagged</span>
            </div>
            <p class="mt-1 text-xs text-slate-400">Big reductions vs previous scrape.</p>
        </div>

        <div class="app-card p-4 bg-gradient-to-br from-amber-500/20 via-amber-500/10 to-red-500/10 border-amber-300/20">
            <div class="text-[11px] uppercase tracking-[0.18em] text-slate-300">Recent Spikes</div>
            <div class="mt-2 flex items-baseline gap-2">
                <span class="text-3xl font-semibold text-white">{{ insights.summary.price_rises }}</span>
                <span class="text-xs text-amber-200/80">jumped</span>
            </div>
            <p class="mt-1 text-xs text-slate-400">Large upticks needing validation.</p>
        </div>

        <div class="app-card p-4 bg-gradient-to-br from-emerald-500/15 via-slate-700/30 to-slate-900/60 border-emerald-300/20">
            <div class="text-[11px] uppercase tracking-[0.18em] text-slate-300">New Extremes</div>
            <div class="mt-2 flex items-baseline gap-2">
                <span class="text-3xl font-semibold text-white">{{ insights.summary.new_extremes }}</span>
                <span class="text-xs text-emerald-200/80">lows / highs</span>
            </div>
            <p class="mt-1 text-xs text-slate-400">Items hitting historic bounds.</p>
        </div>

        <div class="app-card p-4 bg-gradient-to-br from-brand-cyan/20 via-sky-500/10 to-slate-700/30 border-sky-300/20">
            <div class="text-[11px] uppercase tracking-[0.18em] text-slate-300">Outliers</div>
            <div class="mt-2 flex items-baseline gap-2">
                <span class="text-3xl font-semibold text-white">{{ insights.summary.outliers }}</span>
                <span class="text-xs text-sky-200/80">across sources</span>
            </div>
            <p class="mt-1 text-xs text-slate-400">Prices far from canonical median.</p>
        </div>

        <div class="app-card p-4 bg-gradient-to-br from-sky-500/20 via-sky-500/10 to-slate-700/30 border-sky-300/20">
            <div class="text-[11px] uppercase tracking-[0.18em] text-slate-300">Stale Sources</div>
            <div class="mt-2 flex items-baseline gap-2">
                <span class="text-3xl font-semibold text-white">{{ insights.summary.stale_sources }}</span>
                <span class="text-xs text-sky-200/80">behind</span>
            </div>
            <p class="mt-1 text-xs text-slate-400">Older than 12h since last scrape.</p>
        </div>

        <div class="app-card p-4 bg-gradient-to-br from-red-500/25 via-red-500/10 to-slate-800/50 border-red-300/30">
            <div class="text-[11px] uppercase tracking-[0.18em] text-slate-300">Recent Failures</div>
            <div class="mt-2 flex items-baseline gap-2">
                <span class="text-3xl font-semibold text-white">{{ insights.summary.recent_failures }}</span>
                <span class="text-xs text-red-200/80">errors</span>
            </div>
            <p class="mt-1 text-xs text-slate-400">Failed runs in last 36h.</p>
        </div>
    </div>

    <section class="grid gap-4 lg:grid-cols-3">
        <div class="app-card lg:col-span-2 overflow-hidden">
            <div class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
                <div>
                    <h2 class="text-sm font-semibold tracking-wide text-white/90">Last-Run Movers</h2>
                    <p class="text-xs text-slate-400 mt-0.5">Biggest swings since the previous scrape</p>
                </div>
                <div class="flex items-center gap-2 text-[11px] uppercase tracking-[0.18em] text-slate-400">
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-emerald-500/10 text-emerald-200 border border-emerald-500/30">Drop</span>
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-amber-500/10 text-amber-100 border border-amber-500/30">Spike</span>
                </div>
            </div>
            <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-white/5">
                <div class="p-6 space-y-4">
                    <div class="text-xs uppercase tracking-[0.18em] text-emerald-200/90">Drops</div>
                    {% if insights.price_drops %}
                        <ul class="space-y-3">
                            {% for item in insights.price_drops %}
                            <li class="p-3 rounded-xl bg-emerald-500/10 border border-emerald-400/30 app-card-hover">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="min-w-0">
                                        <div class="text-sm font-medium text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                        <div class="text-[11px] text-slate-400 mt-1 flex items-center gap-2">
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
                                                {{ source_display_names.get(item.source, item.source) }}
                                            </span>
                                            {% if item.prev_price is not none and item.price is not none %}
                                            <span>{{ "%.2f"|format(item.prev_price) }} → {{ "%.2f"|format(item.price) }} {{ item.currency or '' }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        {% if item.change_pct is not none %}
                                        <div class="text-sm font-semibold text-emerald-200">{{ "%.1f"|format(item.change_pct) }}%</div>
                                        {% endif %}
                                        {% if item.change is not none %}
                                        <div class="text-[11px] text-emerald-100/80">{{ "%.2f"|format(item.change) }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if item.item_id %}
                                <div class="mt-2 text-[11px]">
                                    <a href="/prices/product/{{ item.source }}/{{ item.item_id }}" class="text-brand-cyan hover:text-white">Inspect price series</a>
                                </div>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-sm text-slate-400">No large price drops on the latest scrape.</p>
                    {% endif %}
                </div>

                <div class="p-6 space-y-4">
                    <div class="text-xs uppercase tracking-[0.18em] text-amber-200/90">Spikes</div>
                    {% if insights.price_rises %}
                        <ul class="space-y-3">
                            {% for item in insights.price_rises %}
                            <li class="p-3 rounded-xl bg-amber-500/10 border border-amber-300/30 app-card-hover">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="min-w-0">
                                        <div class="text-sm font-medium text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                        <div class="text-[11px] text-slate-400 mt-1 flex items-center gap-2">
                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
                                                {{ source_display_names.get(item.source, item.source) }}
                                            </span>
                                            {% if item.prev_price is not none and item.price is not none %}
                                            <span>{{ "%.2f"|format(item.prev_price) }} → {{ "%.2f"|format(item.price) }} {{ item.currency or '' }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        {% if item.change_pct is not none %}
                                        <div class="text-sm font-semibold text-amber-200">+{{ "%.1f"|format(item.change_pct) }}%</div>
                                        {% endif %}
                                        {% if item.change is not none %}
                                        <div class="text-[11px] text-amber-100/80">+{{ "%.2f"|format(item.change) }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if item.item_id %}
                                <div class="mt-2 text-[11px]">
                                    <a href="/prices/product/{{ item.source }}/{{ item.item_id }}" class="text-brand-cyan hover:text-white">Inspect price series</a>
                                </div>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-sm text-slate-400">No large price increases on the latest scrape.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <div class="app-card overflow-hidden">
                <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-white">New Lows</h3>
                    <span class="text-xs text-slate-400">{{ insights.new_lows|length }}</span>
                </div>
                <div class="p-5 space-y-3">
                    {% if insights.new_lows %}
                        {% for item in insights.new_lows %}
                        <div class="p-3 rounded-xl bg-white/5 border border-white/10 app-card-hover">
                            <div class="flex items-center justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-sm font-medium text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                    <div class="text-[11px] text-slate-400 mt-0.5 flex items-center gap-2">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
                                            {{ source_display_names.get(item.source, item.source) }}
                                        </span>
                                        <span>{{ "%.2f"|format(item.price) }} {{ item.currency or '' }}</span>
                                        <span class="text-emerald-200">Low {{ "%.2f"|format(item.extreme_price) }}</span>
                                    </div>
                                </div>
                                {% if item.item_id %}
                                <a href="/prices/product/{{ item.source }}/{{ item.item_id }}" class="text-brand-cyan text-xs hover:text-white whitespace-nowrap">Series</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-slate-400">No new lows detected.</p>
                    {% endif %}
                </div>
            </div>

            <div class="app-card overflow-hidden">
                <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-white">New Highs</h3>
                    <span class="text-xs text-slate-400">{{ insights.new_highs|length }}</span>
                </div>
                <div class="p-5 space-y-3">
                    {% if insights.new_highs %}
                        {% for item in insights.new_highs %}
                        <div class="p-3 rounded-xl bg-white/5 border border-white/10 app-card-hover">
                            <div class="flex items-center justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-sm font-medium text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                    <div class="text-[11px] text-slate-400 mt-0.5 flex items-center gap-2">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
                                            {{ source_display_names.get(item.source, item.source) }}
                                        </span>
                                        <span>{{ "%.2f"|format(item.price) }} {{ item.currency or '' }}</span>
                                        <span class="text-amber-200">High {{ "%.2f"|format(item.extreme_price) }}</span>
                                    </div>
                                </div>
                                {% if item.item_id %}
                                <a href="/prices/product/{{ item.source }}/{{ item.item_id }}" class="text-brand-cyan text-xs hover:text-white whitespace-nowrap">Series</a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-slate-400">No new highs detected.</p>
                    {% endif %}
                </div>
            </div>

            <div class="app-card overflow-hidden">
                <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-white">Streak Trends</h3>
                    <span class="text-xs text-slate-400">{{ insights.sustained_drops|length + insights.sustained_rises|length }}</span>
                </div>
                <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-white/5">
                    <div class="p-5">
                        <div class="text-xs uppercase tracking-[0.18em] text-emerald-200/90">Drops</div>
                        {% if insights.sustained_drops %}
                        <ul class="mt-3 space-y-2">
                            {% for item in insights.sustained_drops %}
                            <li class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-400/30 app-card-hover">
                                <div class="text-sm font-medium text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                <div class="text-[11px] text-slate-400 mt-1 flex items-center justify-between">
                                    <span>{{ source_display_names.get(item.source, item.source) }}</span>
                                    <span class="text-emerald-200">{{ "%.1f"|format(item.trend_pct) }}%</span>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="mt-3 text-sm text-slate-400">No sustained drops.</p>
                        {% endif %}
                    </div>
                    <div class="p-5">
                        <div class="text-xs uppercase tracking-[0.18em] text-amber-200/90">Spikes</div>
                        {% if insights.sustained_rises %}
                        <ul class="mt-3 space-y-2">
                            {% for item in insights.sustained_rises %}
                            <li class="p-3 rounded-lg bg-amber-500/10 border border-amber-300/30 app-card-hover">
                                <div class="text-sm font-medium text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                <div class="text-[11px] text-slate-400 mt-1 flex items-center justify-between">
                                    <span>{{ source_display_names.get(item.source, item.source) }}</span>
                                    <span class="text-amber-200">+{{ "%.1f"|format(item.trend_pct) }}%</span>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="mt-3 text-sm text-slate-400">No sustained spikes.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>

    <details class="app-card overflow-hidden group">
        <summary class="px-6 py-4 border-b border-white/10 flex items-center justify-between cursor-pointer select-none">
            <div>
                <h2 class="text-sm font-semibold tracking-wide text-white/90">Longer-Term Movers</h2>
                <p class="text-xs text-slate-400 mt-0.5">Biggest 7d and 30d shifts versus historical baselines</p>
            </div>
            <div class="text-xs text-slate-400 group-open:hidden">Expand</div>
            <div class="text-xs text-slate-400 hidden group-open:block">Collapse</div>
        </summary>
        <div class="p-6 grid gap-6 md:grid-cols-2">
            <div class="space-y-4">
                <div class="text-xs uppercase tracking-[0.18em] text-slate-400">7 Day Movers</div>
                <div class="grid gap-3 md:grid-cols-2">
                    <div>
                        <div class="text-[11px] uppercase tracking-[0.18em] text-emerald-200/90">Drops</div>
                        {% if insights.multi_horizon['7d_drops'] %}
                        <ul class="mt-2 space-y-2">
                            {% for item in insights.multi_horizon['7d_drops'] %}
                            <li class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-400/30 app-card-hover">
                                <div class="text-sm text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                <div class="text-[11px] text-slate-400 mt-1 flex items-center justify-between">
                                    <span>{{ source_display_names.get(item.source, item.source) }}</span>
                                    <span class="text-emerald-200">{{ "%.1f"|format(item.delta_pct) }}%</span>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="mt-2 text-sm text-slate-400">No 7d drops.</p>
                        {% endif %}
                    </div>
                    <div>
                        <div class="text-[11px] uppercase tracking-[0.18em] text-amber-200/90">Spikes</div>
                        {% if insights.multi_horizon['7d_spikes'] %}
                        <ul class="mt-2 space-y-2">
                            {% for item in insights.multi_horizon['7d_spikes'] %}
                            <li class="p-3 rounded-lg bg-amber-500/10 border border-amber-300/30 app-card-hover">
                                <div class="text-sm text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                <div class="text-[11px] text-slate-400 mt-1 flex items-center justify-between">
                                    <span>{{ source_display_names.get(item.source, item.source) }}</span>
                                    <span class="text-amber-200">+{{ "%.1f"|format(item.delta_pct) }}%</span>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="mt-2 text-sm text-slate-400">No 7d spikes.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <div class="text-xs uppercase tracking-[0.18em] text-slate-400">30 Day Movers</div>
                <div class="grid gap-3 md:grid-cols-2">
                    <div>
                        <div class="text-[11px] uppercase tracking-[0.18em] text-emerald-200/90">Drops</div>
                        {% if insights.multi_horizon['30d_drops'] %}
                        <ul class="mt-2 space-y-2">
                            {% for item in insights.multi_horizon['30d_drops'] %}
                            <li class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-400/30 app-card-hover">
                                <div class="text-sm text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                <div class="text-[11px] text-slate-400 mt-1 flex items-center justify-between">
                                    <span>{{ source_display_names.get(item.source, item.source) }}</span>
                                    <span class="text-emerald-200">{{ "%.1f"|format(item.delta_pct) }}%</span>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="mt-2 text-sm text-slate-400">No 30d drops.</p>
                        {% endif %}
                    </div>
                    <div>
                        <div class="text-[11px] uppercase tracking-[0.18em] text-amber-200/90">Spikes</div>
                        {% if insights.multi_horizon['30d_spikes'] %}
                        <ul class="mt-2 space-y-2">
                            {% for item in insights.multi_horizon['30d_spikes'] %}
                            <li class="p-3 rounded-lg bg-amber-500/10 border border-amber-300/30 app-card-hover">
                                <div class="text-sm text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                <div class="text-[11px] text-slate-400 mt-1 flex items-center justify-between">
                                    <span>{{ source_display_names.get(item.source, item.source) }}</span>
                                    <span class="text-amber-200">+{{ "%.1f"|format(item.delta_pct) }}%</span>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                        {% else %}
                        <p class="mt-2 text-sm text-slate-400">No 30d spikes.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </details>

    <details class="app-card overflow-hidden group">
        <summary class="px-6 py-4 border-b border-white/10 flex items-center justify-between cursor-pointer select-none">
            <div>
                <h2 class="text-sm font-semibold tracking-wide text-white/90">Volatility Watch</h2>
                <p class="text-xs text-slate-400 mt-0.5">Items with unstable prices over the last 30 days</p>
            </div>
            <div class="text-xs text-slate-400 group-open:hidden">Expand</div>
            <div class="text-xs text-slate-400 hidden group-open:block">Collapse</div>
        </summary>
        <div class="p-6 space-y-3">
            {% if insights.volatility_items %}
                {% for item in insights.volatility_items %}
                <div class="p-3 rounded-xl bg-white/5 border border-white/10 app-card-hover">
                    <div class="flex items-start justify-between gap-3">
                        <div class="min-w-0">
                            <div class="text-sm font-medium text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                            <div class="text-[11px] text-slate-400 mt-1 flex items-center gap-2">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
                                    {{ source_display_names.get(item.source, item.source) }}
                                </span>
                                {% if item.price is not none %}
                                <span>{{ "%.2f"|format(item.price) }} {{ item.currency or '' }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs uppercase tracking-[0.18em] text-slate-400">Volatility</div>
                            <div class="text-sm font-semibold text-white">{{ "%.1f"|format(item.cv * 100) }}%</div>
                        </div>
                    </div>
                    {% if item.item_id %}
                    <div class="mt-2 text-[11px]">
                        <a href="/prices/product/{{ item.source }}/{{ item.item_id }}" class="text-brand-cyan hover:text-white">Inspect price series</a>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p class="text-sm text-slate-400">No volatility signals yet.</p>
            {% endif %}
        </div>
    </details>

    <section class="grid gap-4 lg:grid-cols-3">
        <div class="app-card overflow-hidden">
            <div class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
                <div>
                    <h2 class="text-sm font-semibold tracking-wide text-white/90">Cross-Source Outliers</h2>
                    <p class="text-xs text-slate-400 mt-0.5">Items far from their canonical median</p>
                </div>
                <div class="text-xs text-slate-400">{{ insights.outliers|length }}</div>
            </div>
            <div class="p-6 space-y-3">
                {% if insights.outliers %}
                    {% for item in insights.outliers %}
                    <div class="p-3 rounded-xl bg-sky-500/10 border border-sky-400/30 app-card-hover">
                        <div class="text-[11px] text-slate-400 uppercase tracking-[0.18em]">{{ item.canonical_name }}</div>
                        <div class="mt-1 flex items-start justify-between gap-3">
                            <div class="min-w-0">
                                <div class="text-sm font-medium text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                <div class="text-[11px] text-slate-400 mt-0.5 flex items-center gap-2">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
                                        {{ source_display_names.get(item.source, item.source) }}
                                    </span>
                                    <span>{{ "%.2f"|format(item.price) }} {{ item.currency or '' }}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-slate-400">Δ vs median</div>
                                <div class="text-sm font-semibold text-sky-200">
                                    {% if item.deviation_pct >= 0 %}+{% endif %}{{ "%.1f"|format(item.deviation_pct) }}%
                                </div>
                            </div>
                        </div>
                        <div class="mt-2 text-[11px] flex items-center gap-3">
                            <a href="/prices/canonical/{{ item.canonical_id }}" class="text-brand-cyan hover:text-white">Compare sources</a>
                            {% if item.item_id %}
                            <a href="/prices/product/{{ item.source }}/{{ item.item_id }}" class="text-slate-400 hover:text-white">Series</a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-slate-400">No outliers across canonicals.</p>
                {% endif %}
            </div>
        </div>

        <div class="app-card overflow-hidden">
            <div class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
                <div>
                    <h2 class="text-sm font-semibold tracking-wide text-white/90">Most Dispersed Canonicals</h2>
                    <p class="text-xs text-slate-400 mt-0.5">Largest spreads across sources</p>
                </div>
                <div class="text-xs text-slate-400">{{ insights.dispersion_leaders|length }}</div>
            </div>
            <div class="p-6 space-y-3">
                {% if insights.dispersion_leaders %}
                    {% for row in insights.dispersion_leaders %}
                    <div class="p-3 rounded-xl bg-white/5 border border-white/10 app-card-hover">
                        <div class="flex items-start justify-between gap-3">
                            <div class="min-w-0">
                                <div class="text-sm font-medium text-white truncate" title="{{ row.name }}">{{ row.name }}</div>
                                <div class="text-[11px] text-slate-400 mt-1">
                                    {{ "%.2f"|format(row.min_price) }} → {{ "%.2f"|format(row.max_price) }}
                                    (median {{ "%.2f"|format(row.median_price) }})
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-slate-400">Spread</div>
                                <div class="text-sm font-semibold text-amber-200">{{ "%.1f"|format(row.spread_pct) }}%</div>
                            </div>
                        </div>
                        <div class="mt-2 text-[11px]">
                            <a href="/prices/canonical/{{ row.canonical_id }}" class="text-brand-cyan hover:text-white">Open canonical</a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-slate-400">No dispersion signals yet.</p>
                {% endif %}
            </div>
        </div>

        <div class="app-card overflow-hidden">
            <div class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
                <div>
                    <h2 class="text-sm font-semibold tracking-wide text-white/90">Canonical Movers</h2>
                    <p class="text-xs text-slate-400 mt-0.5">Median movement across linked sources</p>
                </div>
                <div class="text-xs text-slate-400">{{ insights.canonical_drops|length + insights.canonical_spikes|length }}</div>
            </div>
            <div class="grid md:grid-cols-2 divide-y md:divide-y-0 md:divide-x divide-white/5">
                <div class="p-6 space-y-3">
                    <div class="text-xs uppercase tracking-[0.18em] text-emerald-200/90">Drops</div>
                    {% if insights.canonical_drops %}
                        {% for row in insights.canonical_drops %}
                        <div class="p-3 rounded-lg bg-emerald-500/10 border border-emerald-400/30 app-card-hover">
                            <div class="flex items-center justify-between gap-3">
                                <div class="text-sm font-medium text-white truncate" title="{{ row.name }}">{{ row.name }}</div>
                                <div class="text-sm font-semibold text-emerald-200">{{ "%.1f"|format(row.pct_change) }}%</div>
                            </div>
                            <div class="mt-1 text-[11px] text-slate-400">
                                {{ "%.2f"|format(row.prev_median_price) }} → {{ "%.2f"|format(row.median_price) }}
                            </div>
                            <div class="mt-2 text-[11px]">
                                <a href="/prices/canonical/{{ row.canonical_id }}" class="text-brand-cyan hover:text-white">Compare sources</a>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-slate-400">No canonical drops.</p>
                    {% endif %}
                </div>
                <div class="p-6 space-y-3">
                    <div class="text-xs uppercase tracking-[0.18em] text-amber-200/90">Spikes</div>
                    {% if insights.canonical_spikes %}
                        {% for row in insights.canonical_spikes %}
                        <div class="p-3 rounded-lg bg-amber-500/10 border border-amber-300/30 app-card-hover">
                            <div class="flex items-center justify-between gap-3">
                                <div class="text-sm font-medium text-white truncate" title="{{ row.name }}">{{ row.name }}</div>
                                <div class="text-sm font-semibold text-amber-200">+{{ "%.1f"|format(row.pct_change) }}%</div>
                            </div>
                            <div class="mt-1 text-[11px] text-slate-400">
                                {{ "%.2f"|format(row.prev_median_price) }} → {{ "%.2f"|format(row.median_price) }}
                            </div>
                            <div class="mt-2 text-[11px]">
                                <a href="/prices/canonical/{{ row.canonical_id }}" class="text-brand-cyan hover:text-white">Compare sources</a>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-slate-400">No canonical spikes.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <details class="app-card overflow-hidden group">
        <summary class="px-6 py-4 border-b border-white/10 flex items-center justify-between cursor-pointer select-none">
            <div>
                <h2 class="text-sm font-semibold tracking-wide text-white/90">Returned To Normal</h2>
                <p class="text-xs text-slate-400 mt-0.5">Previously outlier sources now within range</p>
            </div>
            <div class="text-xs text-slate-400 group-open:hidden">Expand</div>
            <div class="text-xs text-slate-400 hidden group-open:block">Collapse</div>
        </summary>
        <div class="p-6 space-y-3">
            {% if insights.returned_to_normal %}
                {% for item in insights.returned_to_normal %}
                <div class="p-3 rounded-xl bg-white/5 border border-white/10 app-card-hover">
                    <div class="text-[11px] text-slate-400 uppercase tracking-[0.18em]">{{ item.canonical_name }}</div>
                    <div class="mt-1 flex items-start justify-between gap-3">
                        <div class="min-w-0">
                            <div class="text-sm font-medium text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                            <div class="text-[11px] text-slate-400 mt-0.5 flex items-center gap-2">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
                                    {{ source_display_names.get(item.source, item.source) }}
                                </span>
                                <span>{{ "%.2f"|format(item.prev_price) }} → {{ "%.2f"|format(item.price) }} {{ item.currency or '' }}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-400">Prev dev</div>
                            <div class="text-sm font-semibold text-white">{{ "%.1f"|format(item.dev_prev) }}%</div>
                        </div>
                    </div>
                    <div class="mt-2 text-[11px]">
                        <a href="/prices/canonical/{{ item.canonical_id }}" class="text-brand-cyan hover:text-white">Open canonical</a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-sm text-slate-400">No recent returns-to-normal.</p>
            {% endif %}
        </div>
    </details>

    <section class="grid gap-4 lg:grid-cols-2">
        <div class="app-card overflow-hidden">
            <div class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
                <div>
                    <h2 class="text-sm font-semibold tracking-wide text-white/90">Fresh Arrivals</h2>
                    <p class="text-xs text-slate-400 mt-0.5">First seen within the last 24 hours</p>
                </div>
                <div class="text-xs text-slate-400">{{ insights.new_arrivals|length }} new</div>
            </div>
            <div class="p-6 space-y-3">
                {% if insights.new_arrivals %}
                    {% for item in insights.new_arrivals %}
                    <div class="p-3 rounded-xl bg-white/5 border border-white/10 app-card-hover">
                        <div class="flex items-start justify-between gap-3">
                            <div class="min-w-0">
                                <div class="text-sm font-medium text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                <div class="text-xs text-slate-400 mt-0.5 flex items-center gap-2">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
                                        {{ source_display_names.get(item.source, item.source) }}
                                    </span>
                                    {% if item.price is not none %}
                                    <span>{{ "%.2f"|format(item.price) }} {{ item.currency or '' }}</span>
                                    {% else %}
                                    <span class="text-amber-200">No price</span>
                                    {% endif %}
                                </div>
                            </div>
                            <span class="text-[11px] text-slate-400">{{ item.age_hours }}h ago</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-slate-400">Nothing new in the last day.</p>
                {% endif %}
            </div>
        </div>

        <div class="app-card overflow-hidden">
            <div class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
                <div>
                    <h2 class="text-sm font-semibold tracking-wide text-white/90">Dormant Revivals</h2>
                    <p class="text-xs text-slate-400 mt-0.5">Items returning after long gaps</p>
                </div>
                <div class="text-xs text-slate-400">{{ insights.dormant_revived|length }}</div>
            </div>
            <div class="p-6 space-y-3">
                {% if insights.dormant_revived %}
                    {% for item in insights.dormant_revived %}
                    <div class="p-3 rounded-xl bg-white/5 border border-white/10 app-card-hover">
                        <div class="flex items-start justify-between gap-3">
                            <div class="min-w-0">
                                <div class="text-sm font-medium text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                                <div class="text-[11px] text-slate-400 mt-1 flex items-center gap-2">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
                                        {{ source_display_names.get(item.source, item.source) }}
                                    </span>
                                    {% if item.price is not none %}
                                    <span>{{ "%.2f"|format(item.price) }} {{ item.currency or '' }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-amber-200">{{ item.gap_days }}d gap</div>
                                <div class="text-[11px] text-slate-500">{{ item.prev_seen[:16].replace('T',' ') if item.prev_seen }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-slate-400">No dormant revivals detected.</p>
                {% endif %}
            </div>
        </div>
    </section>

    <section class="grid gap-4 lg:grid-cols-3">
        <div class="app-card lg:col-span-2 overflow-hidden">
            <div class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
                <div>
                    <h2 class="text-sm font-semibold tracking-wide text-white/90">Coverage & Data Quality</h2>
                    <p class="text-xs text-slate-400 mt-0.5">Where to focus linking and enrichment</p>
                </div>
                <div class="flex items-center gap-2 text-xs text-slate-400">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
                        Unlinked {{ insights.summary.unlinked_products }}
                    </span>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
                        Missing price {{ insights.summary.missing_prices }}
                    </span>
                </div>
            </div>
            <div class="p-6">
                {% if insights.coverage %}
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="text-xs uppercase tracking-[0.2em] text-slate-400">
                            <tr>
                                <th class="pb-2 text-left font-semibold">Source</th>
                                <th class="pb-2 text-right font-semibold">Coverage</th>
                                <th class="pb-2 text-right font-semibold">Unlinked</th>
                                <th class="pb-2 text-right font-semibold">Missing Price</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            {% for row in insights.coverage %}
                            <tr class="hover:bg-white/5">
                                <td class="py-2">
                                    <div class="text-white text-sm">{{ source_display_names.get(row.source, row.source) }}</div>
                                    <div class="text-[11px] text-slate-500">Latest: {{ row.scraped_at[:16].replace('T',' ') if row.scraped_at }}</div>
                                </td>
                                <td class="py-2 text-right">
                                    <span class="inline-flex items-center justify-end px-2 py-1 rounded-md bg-white/5 text-emerald-200 border border-emerald-500/30">
                                        {{ "%.1f"|format(row.coverage_pct) }}%
                                    </span>
                                    <div class="text-[11px] text-slate-500">{{ row.total_products }} items</div>
                                </td>
                                <td class="py-2 text-right">
                                    <span class="text-amber-200 font-medium">{{ row.unlinked_products }}</span>
                                </td>
                                <td class="py-2 text-right">
                                    <span class="text-red-200 font-medium">{{ row.missing_prices }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p class="text-sm text-slate-400">No coverage metrics yet.</p>
                {% endif %}
            </div>
        </div>

        <div class="space-y-4">
            <div class="app-card overflow-hidden">
                <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-white">Thin Canonical Coverage</h3>
                    <span class="text-xs text-slate-400">{{ insights.canonical_gaps|length }}</span>
                </div>
                <div class="p-5 space-y-3">
                    {% if insights.canonical_gaps %}
                        {% for row in insights.canonical_gaps %}
                        <div class="p-3 rounded-xl bg-white/5 border border-white/10 app-card-hover">
                            <div class="flex items-center justify-between gap-3">
                                <div class="min-w-0">
                                    <div class="text-sm font-medium text-white truncate" title="{{ row.name }}">{{ row.name }}</div>
                                    <div class="text-[11px] text-slate-500 mt-0.5">Links: {{ row.link_count }}</div>
                                </div>
                                <a href="/products/{{ row.id }}" class="text-brand-cyan text-xs hover:text-white whitespace-nowrap">Open</a>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-slate-400">All canonicals have coverage.</p>
                    {% endif %}
                </div>
            </div>

            <div class="app-card overflow-hidden">
                <div class="px-5 py-4 border-b border-white/10 flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-white">Missing Price Samples</h3>
                    <span class="text-xs text-slate-400">{{ insights.missing_prices|length }}</span>
                </div>
                <div class="p-5 space-y-2">
                    {% if insights.missing_prices %}
                        {% for item in insights.missing_prices %}
                        <div class="p-3 rounded-lg bg-slate-800/60 border border-slate-700/60 app-card-hover">
                            <div class="text-sm font-medium text-white truncate" title="{{ item.name }}">{{ item.name }}</div>
                            <div class="text-[11px] text-slate-400 mt-0.5 flex items-center gap-2">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-white/5 border border-white/10">
                                    {{ source_display_names.get(item.source, item.source) }}
                                </span>
                                <span class="text-amber-200">No price captured</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-sm text-slate-400">No missing price records in the latest scrape.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <section class="grid gap-4 lg:grid-cols-3">
        <div class="app-card overflow-hidden">
            <div class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
                <div>
                    <h2 class="text-sm font-semibold tracking-wide text-white/90">Freshness</h2>
                    <p class="text-xs text-slate-400 mt-0.5">Sources that are behind schedule</p>
                </div>
                <div class="text-xs text-slate-400">{{ insights.stale_sources|length }}</div>
            </div>
            <div class="p-6 space-y-3">
                {% if insights.stale_sources %}
                    {% for source in insights.stale_sources %}
                    <div class="p-3 rounded-xl bg-slate-800/60 border border-slate-700/60 app-card-hover">
                        <div class="flex items-center justify-between gap-3">
                            <div>
                                <div class="text-sm font-medium text-white">{{ source_display_names.get(source.source, source.source) }}</div>
                                <div class="text-[11px] text-slate-400 mt-0.5">Last scrape {{ source.last_scraped[:16].replace('T',' ') if source.last_scraped }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-amber-200">{{ source.age_hours }}h old</div>
                                <div class="text-[11px] text-slate-500">Threshold: 12h</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-slate-400">All sources have fresh runs.</p>
                {% endif %}
            </div>
        </div>

        <div class="app-card lg:col-span-2 overflow-hidden">
            <div class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
                <div>
                    <h2 class="text-sm font-semibold tracking-wide text-white/90">Scrape Reliability</h2>
                    <p class="text-xs text-slate-400 mt-0.5">Failures in the last 36 hours</p>
                </div>
                <div class="text-xs text-slate-400">{{ insights.recent_failures|length }} issues</div>
            </div>
            <div class="p-6 space-y-3">
                {% if insights.recent_failures %}
                    {% for run in insights.recent_failures %}
                    <div class="p-3 rounded-xl bg-red-500/10 border border-red-400/30 app-card-hover">
                        <div class="flex items-start justify-between gap-3">
                            <div class="min-w-0">
                                <div class="text-sm font-semibold text-white">{{ source_display_names.get(run.scraper_name, run.scraper_name) }}</div>
                                <div class="text-xs text-red-200 mt-0.5">{{ run.error_message or 'Unknown error' }}</div>
                                <div class="text-[11px] text-slate-400 mt-1">Started {{ run.started_at[:16].replace('T',' ') if run.started_at }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-red-100 uppercase tracking-[0.18em]">Failed</div>
                                {% if run.duration_seconds %}
                                <div class="text-[11px] text-slate-400">{{ "%.1f"|format(run.duration_seconds) }}s</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-slate-400">No recent failures recorded.</p>
                {% endif %}
            </div>
        </div>
    </section>
</div>
{% endblock %}
