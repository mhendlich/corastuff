{% extends "base.html" %}

{% block title %}Scraper Builder - Blackroll Scraper{% endblock %}

{% block breadcrumbs %}
<div class="text-xs text-slate-400">
    <a href="/scrapers" class="hover:text-white">Scrapers</a>
    <span class="mx-2 text-slate-600">/</span>
    <span class="text-slate-300">Builder</span>
</div>
{% endblock %}

{% block page_title %}Scraper Builder{% endblock %}
{% block page_subtitle %}
<p class="mt-1 text-sm text-slate-400">Submit a URL and let Codex add a new scraper + live test.</p>
{% endblock %}

{% block page_actions %}
<a href="/scrapers" class="app-btn-secondary inline-flex items-center px-3 py-2 rounded-md text-sm font-medium">
    Back
</a>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="app-card p-5 border border-white/10" data-no-fade>
        <div class="flex items-start justify-between gap-6">
            <div class="min-w-0">
                <h2 class="text-sm font-semibold text-white/90">Add scraper via Codex</h2>
                <p class="mt-1 text-xs text-slate-400">
                    Only one run can happen at a time. Output streams live and is refresh-safe.
                </p>
            </div>
            <div class="flex items-center gap-2 shrink-0">
                <button id="scraper-builder-cancel"
                    type="button"
                    disabled
                    class="app-btn-secondary inline-flex items-center px-3 py-2 rounded-md text-sm font-medium disabled:opacity-40 disabled:cursor-not-allowed">
                    Cancel
                </button>
            </div>
        </div>

        <form id="scraper-builder-form" class="mt-4 grid grid-cols-1 md:grid-cols-12 gap-3">
            <div class="md:col-span-7">
                <label class="block text-xs text-slate-400 mb-1">Target URL</label>
                <input
                    id="scraper-builder-url"
                    name="url"
                    type="url"
                    required
                    placeholder="https://example.com/collections/..."
                    class="w-full rounded-md bg-white/5 border border-white/10 px-3 py-2 text-sm text-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-brand/50">
            </div>
            <div class="md:col-span-3">
                <label class="block text-xs text-slate-400 mb-1">Password</label>
                <input
                    id="scraper-builder-password"
                    name="password"
                    type="password"
                    required
                    placeholder="michi"
                    class="w-full rounded-md bg-white/5 border border-white/10 px-3 py-2 text-sm text-white placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-brand/50">
            </div>
            <div class="md:col-span-2 flex items-end">
                <button
                    id="scraper-builder-start"
                    type="submit"
                    class="app-btn inline-flex w-full items-center justify-center px-4 py-2 rounded-md text-sm font-semibold">
                    Start
                </button>
            </div>
        </form>

        <div class="mt-4 flex flex-wrap items-center justify-between gap-3 text-xs">
            <div id="scraper-builder-status" class="text-slate-300">Idle</div>
            <div id="scraper-builder-meta" class="text-slate-500"></div>
        </div>

        <pre id="scraper-builder-log"
            class="mt-3 h-96 overflow-auto rounded-lg bg-black/30 border border-white/10 p-3 text-xs text-slate-200 whitespace-pre-wrap font-mono"></pre>
        <div class="mt-2 text-[11px] text-slate-500">
            Logs persist in <code class="font-mono text-slate-300">data/scraper_builder/</code>.
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    (function() {
        const form = document.getElementById("scraper-builder-form");
        const urlInput = document.getElementById("scraper-builder-url");
        const passwordInput = document.getElementById("scraper-builder-password");
        const startBtn = document.getElementById("scraper-builder-start");
        const cancelBtn = document.getElementById("scraper-builder-cancel");
        const statusEl = document.getElementById("scraper-builder-status");
        const metaEl = document.getElementById("scraper-builder-meta");
        const logEl = document.getElementById("scraper-builder-log");

        if (!form) return;

        let es = null;
        let offset = 0;

        function setStatus(text, tone) {
            statusEl.textContent = text;
            statusEl.className = "text-slate-300";
            if (tone === "ok") statusEl.className = "text-emerald-200";
            if (tone === "warn") statusEl.className = "text-amber-200";
            if (tone === "bad") statusEl.className = "text-red-200";
        }

        function setMeta(text) {
            metaEl.textContent = text || "";
        }

        function setControls(running) {
            startBtn.disabled = !!running;
            urlInput.disabled = !!running;
            passwordInput.disabled = !!running;
            cancelBtn.disabled = !running;
        }

        function decodeChunk(b64) {
            if (!b64) return "";
            const bin = atob(b64);
            const bytes = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
            return new TextDecoder("utf-8").decode(bytes);
        }

        function appendLog(text) {
            if (!text) return;
            const atBottom = (logEl.scrollTop + logEl.clientHeight) >= (logEl.scrollHeight - 8);
            logEl.textContent += text;
            if (atBottom) logEl.scrollTop = logEl.scrollHeight;
        }

        function connect(jobId, startOffset) {
            if (es) es.close();
            offset = startOffset || 0;
            es = new EventSource(`/api/scraper-builder/stream?job_id=${encodeURIComponent(jobId)}&offset=${offset}`);
            es.onmessage = (e) => {
                try {
                    const payload = JSON.parse(e.data || "{}");
                    appendLog(decodeChunk(payload.chunk_b64));
                    if (typeof payload.offset === "number") offset = payload.offset;
                    if (payload.done) {
                        es.close();
                        es = null;
                        refreshStatus();
                    }
                } catch (_) {}
            };
            es.onerror = () => {
                if (es) es.close();
                es = null;
                setTimeout(() => refreshStatus(), 800);
            };
        }

        async function refreshStatus() {
            const res = await fetch("/api/scraper-builder/status", { headers: { "Accept": "application/json" } });
            const data = await res.json();
            const job = data.job;
            if (!job) {
                window.__disableDevAutoReload = false;
                setControls(false);
                setStatus("Idle", null);
                setMeta("");
                logEl.textContent = "";
                return;
            }

            const state = (job.state || "unknown").toLowerCase();
            const url = job.url || "";
            const startedAt = job.started_at || "";
            const newScraper = job.new_scraper || "";
            const error = job.error || "";

            setMeta([url, startedAt].filter(Boolean).join(" · "));

            if (data.log && typeof data.log.text === "string") {
                logEl.textContent = data.log.text;
                offset = typeof data.log.file_size === "number" ? data.log.file_size : 0;
                logEl.scrollTop = logEl.scrollHeight;
            }

            if (state === "running") {
                window.__disableDevAutoReload = true;
                setControls(true);
                setStatus("Running…", "warn");
                if (!es) connect(job.job_id, offset);
                return;
            }

            window.__disableDevAutoReload = false;
            setControls(false);
            if (es) { es.close(); es = null; }

            if (state === "success") {
                setStatus(`Success${newScraper ? ": " + newScraper : ""}`, "ok");
                return;
            }
            if (state === "canceled") {
                setStatus("Canceled (cleanup attempted)", "warn");
                return;
            }
            setStatus(`Failed${error ? ": " + error : ""}`, "bad");
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            setStatus("Starting…", "warn");
            setControls(true);

            const fd = new FormData(form);
            const res = await fetch("/api/scraper-builder/start", { method: "POST", body: fd });
            const body = await res.json().catch(() => ({}));
            if (!res.ok) {
                window.__disableDevAutoReload = false;
                setControls(false);
                setStatus(`Failed to start${body && body.detail ? ": " + body.detail : ""}`, "bad");
                return;
            }
            window.__disableDevAutoReload = true;
            logEl.textContent = "";
            offset = 0;
            connect(body.job_id, 0);
            setStatus("Running…", "warn");
            setMeta([urlInput.value || ""].filter(Boolean).join(" · "));
        });

        cancelBtn.addEventListener("click", async () => {
            cancelBtn.disabled = true;
            await fetch("/api/scraper-builder/cancel", { method: "POST" }).catch(() => {});
            setTimeout(() => refreshStatus(), 600);
        });

        refreshStatus();
    })();
</script>
{% endblock %}

